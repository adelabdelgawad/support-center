â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    T017: SignalR Cache Integration                          â”‚
â”‚                    Real-time Message Caching Flow                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SignalR    â”‚         â”‚  SignalR Manager â”‚         â”‚     UI       â”‚
â”‚   Server     â”‚         â”‚  (This Task)     â”‚         â”‚  Components  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚                          â”‚
       â”‚ 1. ReceiveMessage         â”‚                          â”‚
       â”‚    (WebSocket event)      â”‚                          â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
       â”‚                          â”‚                          â”‚
       â”‚                          â”‚ 2. routeToHandlers()     â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                          â”‚    (Update React state)  â”‚
       â”‚                          â”‚                          â”‚
       â”‚                          â”‚ 3. toCachedMessage()     â”‚
       â”‚                          â”‚    (Convert format)      â”‚
       â”‚                          â”‚                          â”‚
       â”‚                          â”‚ 4. messageCache.add()    â”‚
       â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
       â”‚                          â”‚                          â”‚â”‚
       â”‚                          â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                          â”‚                    â”‚  IndexedDB   â”‚
       â”‚                          â”‚                    â”‚  (Messages)  â”‚
       â”‚                          â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚                           â”‚
       â”‚                          â”‚ 5. updateSyncState()      â”‚
       â”‚                          â”‚    (lastSyncedSequence)   â”‚
       â”‚                          â”‚                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                          â”‚                    â”‚  IndexedDB   â”‚
       â”‚                          â”‚                    â”‚ (Chat Meta)  â”‚
       â”‚                          â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚                           â”‚
       â”‚                          â”‚ 6. Log success/error      â”‚
       â”‚                          â”‚                          â”‚


Key Features:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… NON-BLOCKING: UI updates happen immediately, cache write is async
âœ… ERROR RESILIENT: Cache failures don't break real-time messaging
âœ… SYNC CHECKPOINT: Tracks lastSyncedSequence for future delta sync
âœ… AUTO-INITIALIZE: Creates ChatSyncState for first message in chat
âœ… CLEANUP: Clears messageCache reference on disconnect


Data Structures:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SignalR ChatMessage â†’ CachedMessage
â”œâ”€â”€ id: string               â†’ id: string
â”œâ”€â”€ requestId: string        â†’ requestId: string
â”œâ”€â”€ sequenceNumber: number   â†’ sequenceNumber: number
â”œâ”€â”€ senderId: string         â†’ senderId: string
â”œâ”€â”€ sender: SenderInfo       â†’ sender: { id, username, fullName, isTechnician }
â”œâ”€â”€ content: string          â†’ content: string
â”œâ”€â”€ createdAt: string        â†’ createdAt: string (ISO 8601)
â”œâ”€â”€ isRead: boolean          â†’ isReadByCurrentUser: boolean
â”œâ”€â”€ status: 'sending'        â†’ status: 'pending'
â”‚   'sent'          â†’        â†’        'sent'
â”‚   'failed'        â†’        â†’        'failed'
â””â”€â”€ [attachments, etc]       â†’ [mapped fields]
                            + _cachedAt: number
                            + _syncVersion: number


IndexedDB Schema:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Database: support-center-{userId}

Store: messages
â”œâ”€â”€ Key: id (string)
â”œâ”€â”€ Index: by_request â†’ requestId
â”œâ”€â”€ Index: by_request_sequence â†’ [requestId, sequenceNumber]
â””â”€â”€ Index: by_cached_at â†’ _cachedAt

Store: chat_meta
â”œâ”€â”€ Key: requestId (string)
â”œâ”€â”€ Value: {
â”‚     requestId: string
â”‚     lastSyncedSequence: number  â† Checkpoint for delta sync
â”‚     lastSyncedAt: number
â”‚     messageCount: number
â”‚     knownGaps: SequenceGap[]
â”‚     unreadCount: number
â”‚     lastReadSequence: number
â”‚     mediaSize: number
â”‚     lastAccessedAt: number
â”‚   }


Integration with Future Tasks:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

T017 (Current) âœ…    Write SignalR messages to cache
                         â†“
T018 (Backend)       Delta sync API endpoint
GET /api/v1/chats/{requestId}/delta-sync?sinceSequence={n}
                         â†“
T019 (Frontend)      Read cache on page load
If cache.hasMessages(requestId):
  â†’ Display cached messages immediately
  â†’ Request delta sync since cache.lastSyncedSequence
                         â†“
T020 (Frontend)      Gap detection & backfill
If gap detected:
  â†’ Request range sync: /delta-sync?startSequence={n}&endSequence={m}


Testing Checklist:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â–¡ Send/receive message via SignalR
â–¡ Verify message appears in IndexedDB (DevTools â†’ Application â†’ IndexedDB)
â–¡ Check chat_meta store shows updated lastSyncedSequence
â–¡ Refresh page and verify cache persists
â–¡ Test error handling: disable IndexedDB permissions, verify no crash
â–¡ Console log shows "ğŸ’¾ Message cached and sync state updated"
